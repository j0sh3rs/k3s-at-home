---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: tempo
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://grafana.github.io/helm-charts
      chart: tempo
      version: 1.8.0
      sourceRef:
        kind: HelmRepository
        name: grafana-charts
        namespace: flux-system
      interval: 5m
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
    force: true
  valuesFrom:
    - kind: Secret
      name: tempo-secrets
      valuesKey: s3AccessKey
      targetPath: tempo.storage.trace.s3.access_key
    - kind: Secret
      name: tempo-secrets
      valuesKey: s3SecretKey
      targetPath: tempo.storage.trace.s3.secret_key
  values:
    fullnameOverride: tempo
    nameOverride: tempo
    metricsGenerator:
      enabled: true
      remoteWriteUrl: http://prometheus-prometheus:9090/api/v1/write
    tempoQuery:
      enabled: true
    config: |
        multitenancy_enabled: false
        usage_report:
          reporting_enabled: false
        compactor:
          compaction:
            block_retention: 24h
        cache:
          caches:
            redis:
              endpoint: dragonflydb.infra:6379
              db: 4
        distributor:
          receivers:
                jaeger:
                  protocols:
                    grpc:
                      endpoint: 0.0.0.0:14250
                    thrift_binary:
                      endpoint: 0.0.0.0:6832
                    thrift_compact:
                      endpoint: 0.0.0.0:6831
                    thrift_http:
                      endpoint: 0.0.0.0:14268
                opencensus: null
                otlp:
                  protocols:
                    grpc:
                      endpoint: 0.0.0.0:4317
                    http:
                      endpoint: 0.0.0.0:4318
        ingester:
              {}
        server:
              http_listen_port: 3100
        storage:
              trace:
                backend: s3
                local:
                  path: /var/tempo/traces
                s3:
                  access_key: {{ toYaml .values.tempo.storage.trace.s3.access_key }}
                  bucket: tempo-traces
                  endpoint: s3.68cc.io
                  forcepathstyle: true
                  secret_key: {{ toYaml .values.tempo.storage.trace.s3.secret_key }}
                wal:
                  path: /var/tempo/wal
        querier:
              {}
        query_frontend:
              {}
        overrides:
              per_tenant_override_config: /conf/overrides.yaml
