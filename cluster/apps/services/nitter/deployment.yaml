---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nitter
  namespace: services
  labels:
    app.kubernetes.io/instance: nitter
    app.kubernetes.io/name: nitter
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/instance: nitter
      app.kubernetes.io/name: nitter
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: nitter
        app.kubernetes.io/name: nitter
    spec:
      containers:
        - image: zedeus/nitter:latest
          imagePullPolicy: IfNotPresent
          name: nitter
          ports:
            - containerPort: 8080
              name: http
          volumeMounts:
            - name: config
              mountPath: /src/nitter.conf
              subPath: nitter.conf
      volumes:
        - name: config
          configMap:
            name: nitter-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nitter-config
  namespace: services
data:
  nitter.conf: |
    [Server]
    address = "0.0.0.0"
    port = 8080
    https = true  # disable to enable cookies when not using https
    httpMaxConnections = 100
    staticDir = "./public"
    title = "Titter"
    hostname = "twitter.${SECRET_CLUSTER_DOMAIN}"

    [Cache]
    listMinutes = 240  # how long to cache list info (not the tweets, so keep it high)
    rssMinutes = 10  # how long to cache rss queries
    redisHost = "redis"
    redisPort = 6379
    redisConnections = 20 # connection pool size
    redisMaxConnections = 30
    redisPassword = ""
    # max, new connections are opened when none are available, but if the pool size
    # goes above this, they're closed when released. don't worry about this unless
    # you receive tons of requests per second

    [Config]
    hmacKey = "4ffb3142015edf1755e57b49135d681b2c3eefc8" # random key for cryptographic signing of video urls
    base64Media = false # use base64 encoding for proxied media urls
    tokenCount = 10
    # minimum amount of usable tokens. tokens are used to authorize API requests,
    # but they expire after ~1 hour, and have a limit of 187 requests.
    # the limit gets reset every 15 minutes, and the pool is filled up so there's
    # always at least $tokenCount usable tokens. again, only increase this if
    # you receive major bursts all the time

    # Change default preferences here, see src/prefs_impl.nim for a complete list
    [Preferences]
    theme = "Nitter"
    replaceTwitter = "nitter.${SECRET_CLUSTER_DOMAIN}"
    replaceYouTube = "yt.bth.wtf"
    replaceInstagram = "ig.bth.wtf"
    replaceReddit = "reddit.bth.wtf"
    proxyVideos = true
    hlsPlayback = false
    infiniteScroll = true
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/probe: "true"
    prometheus.io/protocol: tcp
  labels:
    app.kubernetes.io/instance: nitter
    app.kubernetes.io/name: nitter
  name: nitter
  namespace: services
spec:
  ports:
    - name: http
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app.kubernetes.io/instance: nitter
    app.kubernetes.io/name: nitter
  type: ClusterIP
