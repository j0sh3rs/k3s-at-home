---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: haproxy
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://oauth2-proxy.github.io/manifests
      chart: oauth2-proxy
      sourceRef:
        kind: HelmRepository
        name: oauth2-proxy-charts
        namespace: flux-system
      interval: 5m
  values:
    replicaCount: 2
    podAnnotations:
      reloader.stakater.com/auto: "true"
    config:
      cookieName: 'bth-wtf-auth'
      google:
        existingSecret: oauth2-proxy-secrets
    image:
      pullPolicy: Always
    authenticatedEmailsFile:
      enabled: true
      persistence: secret
      template: "oauth2-proxy-secrets"
      restrictedUserAccessKey: "useraccess"
    resources:
      limits:
        cpu: 100m
        memory: 300Mi
      requests:
        cpu: 100m
        memory: 300Mi
    securityContext:
      enabled: true
      allowPrivilegeEscalation: false
      runAsUser: 2000
    sessionStorage:
      type: redis
      redis:
        standalone:
          connectionUrl: "redis://redis.services:6379/6"
