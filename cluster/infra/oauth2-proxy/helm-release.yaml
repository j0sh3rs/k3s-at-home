---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: infra
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://oauth2-proxy.github.io/manifests
      chart: oauth2-proxy
      version: 6.15.0
      sourceRef:
        kind: HelmRepository
        name: oauth2-proxy-charts
        namespace: flux-system
      interval: 5m
  valuesFrom:
    - kind: Secret
      name: oauth2-proxy
      valuesKey: client-id
      targetPath: config.clientID
    - kind: Secret
      name: oauth2-proxy
      valuesKey: client-secret
      targetPath: config.clientSecret
    - kind: Secret
      name: oauth2-proxy
      valuesKey: cookieSecret
      targetPath: config.cookieSecret
    - kind: Secret
      name: oauth2-proxy
      valuesKey: cookieName
      targetPath: config.cookieName
  values:
    replicaCount: 1
    podAnnotations:
      reloader.stakater.com/auto: 'true'
    config:
      configFile: |-
        http_address = "127.0.0.1:80"
        reverse_proxy = true
        pass_basic_auth = true
        pass_user_headers = true
        set_xauthrequest = true
        pass_host_header = true
        silence_ping_logging = true
        upstreams = "file:///dev/null"
        cookie_expire = "2h"
        cookie_refresh = "60m"
        cookie_secure = true
        cookie_httponly = true
        cookie_samesite = "lax"
    image:
      pullPolicy: Always
    authenticatedEmailsFile:
      enabled: true
      persistence: secret
      template: 'oauth2-proxy'
      restrictedUserAccessKey: 'useraccess'
    service:
      portNumber: 80
    metrics:
      servicemonitor:
        enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 135M
      limits:
        cpu: 100m
        memory: 135M
    securityContext:
      enabled: true
      allowPrivilegeEscalation: false
      runAsUser: 2000
    sessionStorage:
      type: redis
      redis:
        standalone:
          connectionUrl: 'redis://redis-master:6379/6'
