---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authentik
  namespace: infra
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.goauthentik.io
      chart: authentik
      version: 2022.11.3
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: flux-system
      interval: 5m
  valuesFrom:
    - kind: Secret
      name: authentik-secrets
      valuesKey: secret_key
      targetPath: authentik.secret_key
    - kind: Secret
      name: authentik-secrets
      valuesKey: email_password
      targetPath: authentik.email.password
    - kind: Secret
      name: authentik-secrets
      valuesKey: email_username
      targetPath: authentik.email.username
    - kind: Secret
      name: authentik-secrets
      valuesKey: postgres_password
      targetPath: authentik.postgresql.password
    - kind: Secret
      name: authentik-secrets
      valuesKey: geoip_licenseKey
      targetPath: geoip.licenseKey
    - kind: Secret
      name: authentik-secrets
      valuesKey: geoip_accountId
      targetPath: geoip.accountId
  values:
    ingress:
      enabled: true
      ingressClassName: 'nginx'
      hosts:
        - host: auth.bth.wtf
          paths:
            - path: '/'
              pathType: Prefix
    authentik:
      email:
        port: 1025
        use_tls: true
        host: '192.168.35.5'
      postgresql:
        host: '192.168.35.5'
        port: 35432
      redis:
        host: redis-master
    geoip:
      enabled: true
      image: maxmindinc/geoipupdate:v4
    prometheus:
      serviceMonitor:
        create: true
      rules:
        create: true
    resources:
      server:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 128Mi
      worker:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 128Mi
